# Цели по метрикам производительности

Целевые значения для Lighthouse / Web Vitals:

| Метрика | Цель | Примечание |
|---------|------|------------|
| **FCP** (First Contentful Paint) | ≤ 1,8 с | Первая отрисовка контента |
| **LCP** (Largest Contentful Paint) | ≤ 2,5 с | Загрузка основного контента (часто изображение) |
| **CLS** (Cumulative Layout Shift) | < 0,1 | Стабильность верстки (width/height у img, резервирование места) |
| **INP** (Interaction to Next Paint) | ≤ 200 мс | Отзывчивость на действия пользователя |

Проверка: Lighthouse в Chrome DevTools (режим Navigation), вкладка Performance. При необходимости — мониторинг в production (например, RUM).

---

## Действия по отчёту PageSpeed (LCP, изображения, блокировка)

Если Lighthouse показывает:

- **LCP > 2,5 с** — главное изображение грузится долго:
  - Убедиться, что для hero используется `preload` (в base.twig уже есть `hero_preload_image`).
  - Отдавать LCP-изображение в WebP, по возможности из ключа 800/1600 (см. `npm run build:images`).
  - Для слайдера intro: в JSON указывать оптимизированные пути (WebP), либо заменить `cover` на объект с 800/1600/raw и подключать через `picture.twig` с `loading="eager"`.
- **«Для изображений не заданы width и height»** — у каждого `<img>` должны быть атрибуты:
  - Запустить `npm run build:images` и держать актуальным `data/img/image-dimensions.json`.
  - В JSON для изображений при необходимости задавать `width` и `height` (picture.twig их подхватывает).
  - Для всех выводов `<img>` использовать `picture.twig` или вручную указывать размеры.
- **Блокирующие запросы / лишний JS/CSS** — отложенная загрузка скриптов (`defer`), при необходимости вынести критичный CSS inline или сократить неиспользуемый код (tree-shake, аудит бандлов).

---

## Мобильный сценарий (медленная сеть)

При эмуляции мобильного устройства и 4G с низкой скоростью LCP и Speed Index сильно зависят от размера и приоритета загрузки hero-изображения.

**Типичные проблемы:** LCP 30+ с, Speed Index 15+ с, «Улучшите загрузку изображений» (≈11 МБ), «Для изображений не заданы width и height», блокировка отрисовки (≈150 мс), длительные задачи в основном потоке.

**Приоритетные действия:**

1. **Hero (LCP) на мобильном**
   - Preload именно той версии, которую отдаёт страница на первом экране (например, 800px WebP для мобильного).
   - В intro не использовать для первого слайда один огромный `cover` (JPG/PNG): заменить на объект с 800/1600/raw WebP и выводить через `picture.twig` с `loading="eager"`, чтобы браузер запросил подходящий размер по `srcset`/`sizes`.
   - Убедиться, что `hero_preload_image` в base.twig указывает на лёгкий URL (например, 800 WebP), а не на raw.

2. **Width/height у всех изображений**
   - Актуальный `data/img/image-dimensions.json` (`npm run build:images`) и использование `picture.twig` (или явные размеры) для всех `<img>`, чтобы убрать предупреждение и стабилизировать CLS.

3. **Снижение блокировки и объёма**
   - Уменьшить блокирующие запросы (критичный CSS, отложить некритичный JS).
   - Сократить неиспользуемый JS/CSS (аудит бандлов, при необходимости разбить код по маршрутам).
   - Держать общий размер сети в разумных пределах (изображения — главный резерв за счёт WebP и размеров 800/1600).

---

## Замер FCP/LCP/CLS/INP и реакция на деградацию

### Способы замера

| Способ | Что даёт | Когда использовать |
|--------|----------|--------------------|
| **Lighthouse (Chrome DevTools)** | FCP, LCP, TBT, CLS, Speed Index по одному прогону (десктоп/мобильная эмуляция). | Ручная проверка после изменений, регрессия перед релизом. |
| **PageSpeed Insights / CI** | Те же метрики в автоматическом прогоне (например, Lighthouse CI в GitHub Actions). | Регулярные проверки, блокировка мержа при падении ниже порога. |
| **RUM (Real User Monitoring)** | Реальные FCP/LCP/CLS/INP у пользователей (Chrome User Experience Report, или отправка через `web-vitals` JS в аналитику). | Понимание производства, приоритет по устройствам/сетям. |

Цели: FCP ≤ 1,8 с, LCP ≤ 2,5 с, CLS < 0,1, INP ≤ 200 мс (см. таблицу в начале документа).

### Реакция на деградацию

1. **LCP вырос** — проверить: размер и формат hero-изображения, preload, блокирующие запросы, серверную задержку. Сравнить с предыдущим Lighthouse/RUM-срезом и изменениями (новые скрипты, тяжёлые картинки, смена CDN).
2. **CLS вырос** — искать новые изображения/виджеты без размеров или контент, вставляемый без резервирования места (реклама, виджеты). Добавить width/height или `aspect-ratio` / резерв по высоте.
3. **FCP/INP деградировали** — проверить рост блокирующего JS/CSS, длинных задач в main thread. Отложить некритичный код, разбить тяжёлые скрипты.
4. **В CI** — задать пороги (например, LCP < 4 с, CLS < 0,15) и при их превышении падать сборкой или оставлять предупреждение; разбор по коммиту/PR.
5. **В RUM** — настроить алерты при проседании перцентилей (например, LCP p75 > 3 с) и разбор по сегментам (страница, устройство, регион).
