# Контракт API: POST /api/send

Используется формой обратной связи (form-callback) для отправки заявки.

## Метод и URL

- **Метод:** `POST`
- **URL:** `/api/send` (относительно корня сайта; с учётом base URL приложения)
- **Content-Type запроса:** `application/x-www-form-urlencoded` или `application/json` (при отправке JSON парсится из тела запроса как `parsedBody`)

## Обязательные и опциональные поля

| Поле              | Тип    | Обязательное | Описание                                                                                                   |
| ----------------- | ------ | ------------ | ---------------------------------------------------------------------------------------------------------- |
| `csrf_token`      | string | да           | Токен CSRF из сессии (передаётся скрытым полем формы). При несовпадении или отсутствии — 419.              |
| `phone`           | string | да           | Номер телефона (цифры, 7–15 символов после удаления нецифровых).                                           |
| `policy`          | string | да           | Должно быть `"on"` — согласие с политикой конфиденциальности.                                              |
| `name`            | string | нет          | Имя (не валидируется на бэкенде в текущей версии).                                                         |
| `email`           | string | нет          | E-mail; если передан — проверяется формат.                                                                 |
| `idempotency_key` | string | нет          | Ключ идемпотентности; при повторе запроса с тем же ключом в течение TTL возвращается закэшированный ответ. |

## Коды ответов

| Код     | Значение       | Описание                                                                                                                                                                                                                                |
| ------- | -------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 200     | OK             | Заявка принята. Тело: `{ "success": true, "message": "...", "request_id": "..." }`.                                                                                                                                                     |
| 419     | Session / CSRF | Неверный или отсутствующий CSRF-токен. Тело: `{ "success": false, "code": "CSRF_INVALID", "message": "...", "request_id": "..." }`. Обновить страницу и повторить.                                                                      |
| 422     | Validation     | Ошибки валидации. Тело: `{ "success": false, "code": "VALIDATION_ERROR", "message": "...", "errors": { ... }, "request_id": "..." }`.                                                                                                   |
| 429     | Rate limit     | Превышен лимит запросов по IP. Тело: `{ "success": false, "code": "RATE_LIMIT_EXCEEDED", "message": "..." }`. Заголовок `Retry-After` — через сколько секунд можно повторить. Настройки: `config/settings.php` → `rate_limit_api_send`. |
| 4xx/5xx | —              | По стандартной обработке ошибок приложения (см. errorMap в конфиге).                                                                                                                                                                    |

Ответ всегда в формате JSON, заголовок `Content-Type: application/json`.

## Валидация на бэкенде

- **phone:** после удаления нецифровых символов длина от 7 до 15.
- **policy:** строго `"on"`.
- **email:** если поле не пустое — `filter_var(..., FILTER_VALIDATE_EMAIL)`.

Дальнейшая санитизация и сохранение заявки (CRM, почта и т.д.) в текущей версии не реализованы; контракт описывает приём и валидацию.

## Связанные файлы

- Обработчик: `src/Action/ApiSendAction.php`
- Форма: `templates/components/form-callback.twig`, `assets/js/components/form-callback/`
